<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">lib/deploy.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/netflix/unleash" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  </ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/deploy.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">const
  colors  = require(&apos;chalk&apos;),
  log     = require(&apos;fancy-log&apos;),
  paqman  = require(&apos;paqman&apos;),
  vinylFS = require(&apos;vinyl-fs&apos;)

function getNextVersion (type) {
  const SemVer = require(&apos;semver&apos;)
  const currentVersion = paqman.packageJSON.version
  log(&apos;Getting next version of type: &apos;, colors.magenta(type))
  log(&apos;Incrementing from version: &apos;, colors.magenta(currentVersion))
  return SemVer.inc(currentVersion, type)
}

module.exports = Object.create({
  getNextVersion: getNextVersion,

  withBumpType: function (options0, options1) {
    const
      Stream         = require(&apos;stream&apos;),
      ChildProcess   = require(&apos;child_process&apos;),
      merge          = require(&apos;lodash.merge&apos;),
      bump           = require(&apos;gulp-bump&apos;),
      filter         = require(&apos;gulp-filter&apos;),
      git            = require(&apos;gulp-git&apos;),
      tagVersion     = require(&apos;gulp-tag-version&apos;)

    // Allow options merge through arguments list.
    // This is useful for bind magic
    const options  = merge({ }, options0, options1),
      bumpType = options.bumpType,
      dryRun = options.dryRun

    log(&apos;Utilizing bumpType&apos;,  colors.magenta(options.bumpType))

    function streamDone (finalOperation) {
      const stream = new Stream.Transform({ objectMode: true })

      stream._transform = function (file, unused, callback) {
        finalOperation()
        callback(null, file)
      }

      return stream
    }

    log(&apos;Retrieving latest git commit...&apos;)

    const
      REF_HEAD_CMD   = &apos;git rev-parse --abbrev-ref HEAD&apos;,
      CURRENT_BRANCH = ChildProcess.execSync(REF_HEAD_CMD)
                         .toString().replace(&apos;\n&apos;,&apos;&apos;),
      NEXT_VERSION   = getNextVersion(bumpType)

    let fileStream = vinylFS.src([ &apos;./package.json&apos; ])

    if (!dryRun) {
      fileStream = fileStream
        .pipe(bump({ type: bumpType }))
        .pipe(vinylFS.dest(&apos;./&apos;))
        .pipe(git.commit(&apos;chore(release): release &apos; + NEXT_VERSION))
        .pipe(filter(&apos;package.json&apos;))
        .pipe(tagVersion())
    }

    return fileStream.pipe(streamDone(function () {
      const
        args   = &apos; --tags&apos;,
        remote = &apos;origin&apos;

      if (dryRun) {
        return log(&apos;This is a dry run. We\&apos;d be running git push &apos; +
                              remote + &apos; &apos; + CURRENT_BRANCH + args)
      }

      return git.push(remote, CURRENT_BRANCH, { args: args }, function (error) {
        if (error) {
          throw error
        }

        log(&apos;Loading NPM....&apos;)

        const NPM = require(&apos;npm&apos;)
        NPM.load(function () { // must be called first
          NPM.publish(function (pubError) {
            if (pubError) {
              log.error(&apos;Publish failed, your changelog may get in an undefined state :(&apos;)
              log.error(pubError)
              throw pubError
            }
          })
        })
      })
    }))
  }
})
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.7)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
